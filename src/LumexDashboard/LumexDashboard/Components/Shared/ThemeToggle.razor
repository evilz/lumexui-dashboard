@inject IJSRuntime JS

@inject AppStateService AppState
@implements IDisposable

<div class="relative">
    <button class="p-2 rounded-lg hover:bg-default-100 transition-colors flex items-center gap-1" 
            @onclick="ToggleTheme" 
            title="@GetTooltip()">
        @if (AppState.ThemeMode == "dark")
        {
            <!-- Sun icon - click to switch to light -->
            <svg class="w-5 h-5 text-yellow-400" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
            </svg>
        }
        else
        {
            <!-- Moon icon - click to switch to dark -->
            <svg class="w-5 h-5 text-default-500" fill="currentColor" viewBox="0 0 24 24">
                <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
            </svg>
        }
    </button>
</div>

@code {
    protected override async Task OnInitializedAsync()
    {
        AppState.OnChange += StateHasChanged;
        
        // Sync initial state if needed, though usually AppState is source of truth.
        // If AppState is fresh (e.g. refresh), we might want to read from localStorage here or in AppStateService.
        // For now, let's assume AppStateService will handle initialization or we do it here.
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var storedMode = await JS.InvokeAsync<string>("eval", "localStorage.getItem('themeMode') || 'light'");
            if (AppState.ThemeMode != storedMode)
            {
                AppState.ThemeMode = storedMode;
                await ApplyTheme();
            }
        }
    }

    private string GetTooltip() => AppState.ThemeMode == "dark" ? "Switch to light mode" : "Switch to dark mode";

    private async Task ToggleTheme()
    {
        var newMode = AppState.ThemeMode == "dark" ? "light" : "dark";
        AppState.ThemeMode = newMode;
        await JS.InvokeVoidAsync("eval", $"localStorage.setItem('themeMode', '{newMode}')");
        await ApplyTheme();
    }

    private async Task ApplyTheme()
    {
        var mode = AppState.ThemeMode;
        await JS.InvokeVoidAsync("eval", $@"
            const html = document.documentElement;
            html.classList.remove('light', 'dark');
            html.classList.add('{mode}');
        ");
    }

    public void Dispose()
    {
        AppState.OnChange -= StateHasChanged;
    }
}
