@inject IJSRuntime JS
@inject NavigationManager NavigationManager
@inject AppStateService AppState
@inject ToastService Toast
@implements IDisposable

<!-- Command Palette Modal -->
@if (AppState.CommandPaletteOpen)
{
    <div class="fixed inset-0 z-[200] flex items-start justify-center pt-[10vh]">
        <!-- Backdrop -->
        <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" @onclick="CloseCommandPalette"></div>
        
        <!-- Modal -->
        <div class="relative w-full max-w-xl bg-background rounded-2xl shadow-2xl border border-divider overflow-hidden animate-scale-in">
            <!-- Search Input -->
            <div class="flex items-center gap-3 px-4 py-3 border-b border-divider">
                <svg class="w-5 h-5 text-default-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
                <input type="text" 
                       @bind="_searchQuery" 
                       @bind:event="oninput"
                       @onkeydown="HandleKeyDown"
                       @ref="_searchInput"
                       placeholder="Type a command or search..." 
                       class="flex-1 bg-transparent text-foreground placeholder-default-400 outline-none text-sm" />
                <kbd class="px-2 py-1 text-xs font-mono bg-default-200 text-default-500 rounded">ESC</kbd>
            </div>

            <!-- Results -->
            <div class="max-h-[400px] overflow-y-auto p-2">
                @if (string.IsNullOrEmpty(_searchQuery))
                {
                    <!-- Recent & Suggestions -->
                    <div class="px-2 py-1.5 text-xs font-semibold text-default-400 uppercase">Quick Actions</div>
                    @foreach (var item in _quickActions)
                    {
                        <button class="@GetItemClass(item)" @onclick="() => ExecuteCommand(item)">
                            <div class="@GetIconBgClass(item.Category) w-8 h-8 rounded-lg flex items-center justify-center">
                                @item.Icon
                            </div>
                            <div class="flex-1 text-left">
                                <p class="text-sm font-medium text-foreground">@item.Title</p>
                                <p class="text-xs text-default-500">@item.Description</p>
                            </div>
                            @if (!string.IsNullOrEmpty(item.Shortcut))
                            {
                                <kbd class="px-2 py-1 text-xs font-mono bg-default-200 text-default-500 rounded">@item.Shortcut</kbd>
                            }
                        </button>
                    }

                    <div class="px-2 py-1.5 mt-2 text-xs font-semibold text-default-400 uppercase">Navigation</div>
                    @foreach (var item in _navigationItems)
                    {
                        <button class="@GetItemClass(item)" @onclick="() => ExecuteCommand(item)">
                            <div class="w-8 h-8 rounded-lg bg-default-100 flex items-center justify-center">
                                @item.Icon
                            </div>
                            <div class="flex-1 text-left">
                                <p class="text-sm font-medium text-foreground">@item.Title</p>
                                <p class="text-xs text-default-500">@item.Description</p>
                            </div>
                        </button>
                    }
                }
                else
                {
                    <!-- Filtered Results -->
                    var filtered = FilteredItems.ToList();
                    @if (filtered.Any())
                    {
                        @foreach (var item in filtered)
                        {
                            <button class="@GetItemClass(item)" @onclick="() => ExecuteCommand(item)">
                                <div class="@GetIconBgClass(item.Category) w-8 h-8 rounded-lg flex items-center justify-center">
                                    @item.Icon
                                </div>
                                <div class="flex-1 text-left">
                                    <p class="text-sm font-medium text-foreground">@item.Title</p>
                                    <p class="text-xs text-default-500">@item.Description</p>
                                </div>
                            </button>
                        }
                    }
                    else
                    {
                        <div class="py-8 text-center">
                            <svg class="w-12 h-12 mx-auto text-default-300 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <p class="text-default-500 text-sm">No results found for "@_searchQuery"</p>
                        </div>
                    }
                }
            </div>

            <!-- Footer -->
            <div class="flex items-center justify-between px-4 py-2 border-t border-divider bg-default-100/50 text-xs text-default-500">
                <div class="flex items-center gap-4">
                    <span class="flex items-center gap-1">
                        <kbd class="px-1.5 py-0.5 bg-default-200 rounded">↑↓</kbd>
                        Navigate
                    </span>
                    <span class="flex items-center gap-1">
                        <kbd class="px-1.5 py-0.5 bg-default-200 rounded">↵</kbd>
                        Select
                    </span>
                </div>
                <span>Powered by LumexUI</span>
            </div>
        </div>
    </div>
}

<style>
    @@keyframes scale-in {
        from {
            transform: scale(0.95);
            opacity: 0;
        }
        to {
            transform: scale(1);
            opacity: 1;
        }
    }
    .animate-scale-in {
        animation: scale-in 0.15s ease-out;
    }
</style>

@code {
    [Parameter] public EventCallback<string> OnNavigate { get; set; }
    [Parameter] public EventCallback<string> OnAction { get; set; }

    private string _searchQuery = string.Empty;
    private int _selectedIndex = 0;
    private ElementReference _searchInput;
    private DotNetObjectReference<CommandPalette>? _dotNetRef;

    private readonly List<CommandItem> _quickActions = new()
    {
        new("New Task", "Create a new task", "action", "⌘N",
            @<svg class="w-4 h-4 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>),
        new("Toggle Theme", "Switch between light and dark mode", "action", "⌘T",
            @<svg class="w-4 h-4 text-warning" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
            </svg>),
        new("Export Data", "Export your data as CSV", "action", "⌘E",
            @<svg class="w-4 h-4 text-success" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
            </svg>),
        new("Settings", "Open application settings", "action", "⌘,",
            @<svg class="w-4 h-4 text-default-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
            </svg>)
    };

    private readonly List<CommandItem> _navigationItems = new()
    {
        new("Dashboard", "Go to dashboard overview", "nav", null,
            @<svg class="w-4 h-4 text-default-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6z"></path>
            </svg>, "/"),
        new("Users", "Manage users", "nav", null,
            @<svg class="w-4 h-4 text-default-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1z"></path>
            </svg>, "/users"),
        new("Finance", "View financial data", "nav", null,
            @<svg class="w-4 h-4 text-default-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2"></path>
            </svg>, "/finance"),
        new("Tasks", "Task management", "nav", null,
            @<svg class="w-4 h-4 text-default-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2"></path>
            </svg>, "/tasks"),
        new("Mailbox", "Check your emails", "nav", null,
            @<svg class="w-4 h-4 text-default-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8"></path>
            </svg>, "/mailbox"),
        new("Calendar", "View and manage events", "nav", null,
            @<svg class="w-4 h-4 text-default-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>, "/calendar")
    };

    private IEnumerable<CommandItem> FilteredItems => 
        _quickActions.Concat(_navigationItems)
            .Where(i => i.Title.Contains(_searchQuery, StringComparison.OrdinalIgnoreCase) ||
                       i.Description.Contains(_searchQuery, StringComparison.OrdinalIgnoreCase));

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            AppState.OnChange += OnStateChanged;
            _dotNetRef = DotNetObjectReference.Create(this);
            await JS.InvokeVoidAsync("eval", @"
                window.registerCommandPaletteRef = (dotNetRef) => {
                    window.commandPaletteRef = dotNetRef;
                    document.addEventListener('keydown', (e) => {
                        if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
                            e.preventDefault();
                            if (window.commandPaletteRef) {
                                window.commandPaletteRef.invokeMethodAsync('OpenFromJs');
                            }
                        }
                    });
                };
            ");
            await JS.InvokeVoidAsync("registerCommandPaletteRef", _dotNetRef);
        }

        if (AppState.CommandPaletteOpen)
        {
            await Task.Delay(50);
            try { await _searchInput.FocusAsync(); } catch (Exception) { /* Element may not be rendered yet */ }
        }
    }

    [JSInvokable]
    public void OpenFromJs()
    {
        AppState.OpenCommandPalette();
        _searchQuery = string.Empty;
        _selectedIndex = 0;
    }

    private void OnStateChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    private void CloseCommandPalette()
    {
        AppState.CloseCommandPalette();
        _searchQuery = string.Empty;
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Escape")
        {
            CloseCommandPalette();
        }
        else if (e.Key == "Enter")
        {
            var items = string.IsNullOrEmpty(_searchQuery) 
                ? _quickActions.Concat(_navigationItems).ToList()
                : FilteredItems.ToList();
            if (items.Any() && _selectedIndex < items.Count)
            {
                await ExecuteCommand(items[_selectedIndex]);
            }
        }
        else if (e.Key == "ArrowDown")
        {
            var count = string.IsNullOrEmpty(_searchQuery) 
                ? _quickActions.Count + _navigationItems.Count 
                : FilteredItems.Count();
            _selectedIndex = Math.Min(_selectedIndex + 1, count - 1);
        }
        else if (e.Key == "ArrowUp")
        {
            _selectedIndex = Math.Max(_selectedIndex - 1, 0);
        }
    }

    private async Task ExecuteCommand(CommandItem item)
    {
        CloseCommandPalette();
        
        if (item.Category == "nav" && !string.IsNullOrEmpty(item.Route))
        {
            NavigationManager.NavigateTo(item.Route);
        }
        else
        {
            await OnAction.InvokeAsync(item.Title);
        }

        // Show toast via Blazor.Sonner
        Toast.Success($"{item.Title}", new ToastModel { Description = "Command executed successfully" });
    }

    private string GetItemClass(CommandItem item)
    {
        return "w-full flex items-center gap-3 px-2 py-2.5 rounded-lg hover:bg-default-100 transition-colors cursor-pointer";
    }

    private string GetIconBgClass(string category) => category switch
    {
        "action" => "bg-primary/10",
        _ => "bg-default-100"
    };

    public void Dispose()
    {
        AppState.OnChange -= OnStateChanged;
        _dotNetRef?.Dispose();
    }

    private record CommandItem(string Title, string Description, string Category, string? Shortcut, RenderFragment Icon, string? Route = null);
}
