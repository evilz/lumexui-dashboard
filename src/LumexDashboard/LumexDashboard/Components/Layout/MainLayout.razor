@inherits LayoutComponentBase
@inject IJSRuntime JS

<div class="flex h-screen overflow-hidden">
    <!-- Sidebar -->
    <aside class="@GetSidebarClasses()">
        <div class="flex flex-col h-full">
            <!-- Logo -->
            <div class="flex items-center gap-3 px-6 py-5">
                <div class="w-8 h-8 bg-primary rounded-lg flex items-center justify-center shrink-0">
                    <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/>
                    </svg>
                </div>
                @if (!_sidebarCollapsed || _sidebarOpen)
                {
                    <span class="text-lg font-semibold text-foreground whitespace-nowrap">LumexDashboard</span>
                }
            </div>

            <!-- Navigation -->
            <nav class="flex-1 px-4 py-6 space-y-1 overflow-y-auto">
                <NavMenu Collapsed="@(_sidebarCollapsed && !_sidebarOpen)" />
            </nav>

            <!-- User Profile -->
            <div class="px-4 py-4 border-t border-divider">
                <div class="flex items-center gap-3">
                    <LumexAvatar Name="John Doe" Size="@Size.Small" />
                    @if (!_sidebarCollapsed || _sidebarOpen)
                    {
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-foreground truncate">John Doe</p>
                            <p class="text-xs text-default-500 truncate">admin@example.com</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </aside>

    <!-- Overlay for mobile -->
    @if (_sidebarOpen)
    {
        <div class="fixed inset-0 bg-black/50 z-20 lg:hidden" @onclick="ToggleSidebar"></div>
    }

    <!-- Main Content Area -->
    <div class="flex-1 flex flex-col overflow-hidden">
        <!-- Top Bar -->
        <header class="w-full h-16 px-4 flex items-center justify-between border-b border-divider bg-background sticky top-0 z-10">
            <!-- Left Section: Menu toggle, Sidebar collapse, Search -->
            <div class="flex items-center gap-3 flex-1">
                <!-- Mobile Menu Toggle -->
                <button class="lg:hidden p-2 rounded-lg hover:bg-default-100 transition-colors" @onclick="ToggleSidebar">
                    <svg class="w-6 h-6 text-default-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
                
                <!-- Desktop Sidebar Collapse Toggle -->
                <button class="hidden lg:flex p-2 rounded-lg hover:bg-default-100 transition-colors" @onclick="ToggleSidebarCollapse" title="@(_sidebarCollapsed ? "Expand sidebar" : "Collapse sidebar")">
                    <svg class="w-5 h-5 text-default-600 transition-transform duration-200 @(_sidebarCollapsed ? "rotate-180" : "")" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7"></path>
                    </svg>
                </button>
                
                <!-- Command Palette Trigger - Larger width -->
                <button class="hidden sm:flex items-center gap-2 px-4 py-2 rounded-lg bg-default-100 hover:bg-default-200 transition-colors text-sm text-default-500 w-64 md:w-80 lg:w-96" 
                        @onclick="OpenCommandPalette">
                    <svg class="w-4 h-4 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    <span class="flex-1 text-left">Search...</span>
                    <kbd class="hidden md:inline-flex items-center gap-1 px-1.5 py-0.5 rounded bg-default-200 text-xs">
                        <span>⌘</span>K
                    </kbd>
                </button>
            </div>

            <!-- Right Section: Notifications, Theme Toggle, Settings -->
            <div class="flex items-center gap-2">
                <NotificationBell />
                <ThemeToggle />
                <ThemeSettings />
            </div>
        </header>

        <!-- Page Content -->
        <main class="flex-1 overflow-y-auto bg-default-100 p-4 lg:p-6">
            @Body
        </main>
    </div>
</div>

<!-- Toast Container -->
<ToastContainer @ref="_toastContainer" />

<!-- Command Palette -->
<CommandPalette @ref="_commandPalette" />

<div id="blazor-error-ui" data-nosnippet>
    An unhandled error has occurred.
    <a href="." class="reload">Reload</a>
    <span class="dismiss">🗙</span>
</div>

@code {
    private bool _sidebarOpen = false;
    private bool _sidebarCollapsed = false;
    private ToastContainer? _toastContainer;
    private CommandPalette? _commandPalette;

    // Navbar classes removed - using custom header element now

    private string GetSidebarClasses()
    {
        var baseClasses = "fixed lg:relative z-30 h-full bg-background border-r border-divider transition-all duration-300 ease-in-out";
        
        // Mobile: full width sidebar with translate
        var mobileClasses = _sidebarOpen ? "translate-x-0 w-64" : "-translate-x-full w-64";
        
        // Desktop: collapsed or expanded
        var desktopClasses = _sidebarCollapsed ? "lg:translate-x-0 lg:w-20" : "lg:translate-x-0 lg:w-64";
        
        return $"{baseClasses} {mobileClasses} {desktopClasses}";
    }

    private void ToggleSidebar()
    {
        _sidebarOpen = !_sidebarOpen;
    }

    private void ToggleSidebarCollapse()
    {
        _sidebarCollapsed = !_sidebarCollapsed;
    }

    private void OpenCommandPalette()
    {
        _commandPalette?.Open();
    }

    // Public method to show toasts from anywhere
    public void ShowToast(string message, string type = "info")
    {
        _toastContainer?.ShowToast(message, type);
    }
}
