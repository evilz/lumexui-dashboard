@page "/tasks"

<PageTitle>Task Management</PageTitle>

<div class="space-y-6">
    <!-- Header & Toolbar -->
    <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
        <div>
            <h1 class="text-2xl font-bold text-default-800">Project Tasks</h1>
            <p class="text-sm text-default-500">Manage and track your team's work progress</p>
        </div>
        <div class="flex items-center gap-2">
            <LumexButton Color="ThemeColor.Primary" Size="Size.Small" OnClick="OpenNewTaskModal">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
                New Task
            </LumexButton>
        </div>
    </div>

    <!-- Toolbar -->
    <LumexCard Class="rounded-xl">
        <LumexCardBody Class="p-3">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-3">
                <!-- View Switcher -->
                <div class="flex items-center gap-2">
                    <div class="flex bg-default-100 rounded-lg p-1">
                        <button class="@GetViewButtonClass("board")" @onclick="@(() => _currentView = "board")">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2"></path>
                            </svg>
                            <span>Board</span>
                        </button>
                        <button class="@GetViewButtonClass("list")" @onclick="@(() => _currentView = "list")">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path>
                            </svg>
                            <span>List</span>
                        </button>
                        <button class="@GetViewButtonClass("calendar")" @onclick="@(() => _currentView = "calendar")">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            <span>Calendar</span>
                        </button>
                    </div>
                </div>

                <!-- Filters & Search -->
                <div class="flex items-center gap-2 flex-wrap">
                    <LumexDropdown>
                        <LumexDropdownTrigger>
                            <LumexButton Variant="Variant.Flat" Size="Size.Small">
                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
                                </svg>
                                Priority
                                <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </LumexButton>
                        </LumexDropdownTrigger>
                        <LumexDropdownMenu AriaLabel="Filter by priority" SelectionMode="SelectionMode.Multiple" @bind-SelectedKeys="_priorityFilter">
                            <LumexDropdownItem Key="high">High</LumexDropdownItem>
                            <LumexDropdownItem Key="medium">Medium</LumexDropdownItem>
                            <LumexDropdownItem Key="low">Low</LumexDropdownItem>
                        </LumexDropdownMenu>
                    </LumexDropdown>

                    <LumexDropdown>
                        <LumexDropdownTrigger>
                            <LumexButton Variant="Variant.Flat" Size="Size.Small">
                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                                Assignee
                                <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </LumexButton>
                        </LumexDropdownTrigger>
                        <LumexDropdownMenu AriaLabel="Filter by assignee" SelectionMode="SelectionMode.Multiple" @bind-SelectedKeys="_assigneeFilter">
                            <LumexDropdownItem Key="alice">Alice Chen</LumexDropdownItem>
                            <LumexDropdownItem Key="bob">Bob Smith</LumexDropdownItem>
                            <LumexDropdownItem Key="carol">Carol White</LumexDropdownItem>
                            <LumexDropdownItem Key="david">David Lee</LumexDropdownItem>
                        </LumexDropdownMenu>
                    </LumexDropdown>

                    <LumexTextbox @bind-Value="_searchQuery" 
                                  Placeholder="Search tasks..." 
                                  Type="InputType.Search"
                                  Size="Size.Small"
                                  Class="w-48"
                                  Classes="_searchClasses" />
                </div>
            </div>
        </LumexCardBody>
    </LumexCard>

    <!-- Board View -->
    @if (_currentView == "board")
    {
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            @foreach (var stage in _stages)
            {
                <div class="flex flex-col min-h-[500px]">
                    <!-- Stage Header -->
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full @stage.Color"></div>
                            <h3 class="font-semibold text-default-800">@stage.Name</h3>
                            <span class="text-xs bg-default-200 px-2 py-0.5 rounded-full">
                                @GetTasksForStage(stage.Key).Count
                            </span>
                        </div>
                        <LumexDropdown>
                            <LumexDropdownTrigger>
                                <LumexButton Variant="Variant.Light" Size="Size.Small" IconOnly="true">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                        <circle cx="12" cy="6" r="2"></circle>
                                        <circle cx="12" cy="12" r="2"></circle>
                                        <circle cx="12" cy="18" r="2"></circle>
                                    </svg>
                                </LumexButton>
                            </LumexDropdownTrigger>
                            <LumexDropdownMenu AriaLabel="Stage actions">
                                <LumexDropdownItem Key="add">Add Task</LumexDropdownItem>
                                <LumexDropdownItem Key="collapse">Collapse</LumexDropdownItem>
                                <LumexDropdownItem Key="clear">Clear All</LumexDropdownItem>
                            </LumexDropdownMenu>
                        </LumexDropdown>
                    </div>

                    <!-- Tasks Drop Zone -->
                    <div class="@GetDropZoneClass(stage.Key)"
                         @ondragover="@(() => OnDragOver(stage.Key))"
                         @ondragover:preventDefault="true"
                         @ondragleave="OnDragLeave"
                         @ondrop="@(() => OnDropOnStage(stage.Key))"
                         @ondrop:preventDefault="true">
                        @foreach (var task in GetTasksForStage(stage.Key))
                        {
                            <div draggable="true"
                                 class="@GetTaskCardClass(task)"
                                 @ondragstart="@(() => OnDragStart(task))"
                                 @ondragend="OnDragEnd"
                                 @onclick="@(() => SelectTask(task))">
                                <LumexCard Class="rounded-xl">
                                    <LumexCardBody Class="p-4 space-y-3">
                                        <!-- Task Header -->
                                        <div class="flex items-start justify-between">
                                            <h4 class="font-medium text-default-800 text-sm">@task.Title</h4>
                                            <LumexDropdown>
                                                <LumexDropdownTrigger>
                                                    <LumexButton Variant="Variant.Light" Size="Size.Small" IconOnly="true" @onclick:stopPropagation="true">
                                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                                            <circle cx="12" cy="6" r="2"></circle>
                                                            <circle cx="12" cy="12" r="2"></circle>
                                                            <circle cx="12" cy="18" r="2"></circle>
                                                        </svg>
                                                    </LumexButton>
                                                </LumexDropdownTrigger>
                                                <LumexDropdownMenu AriaLabel="Task actions">
                                                    <LumexDropdownItem Key="edit">Edit</LumexDropdownItem>
                                                    <LumexDropdownItem Key="rename">Rename</LumexDropdownItem>
                                                    <LumexDropdownItem Key="duplicate">Duplicate</LumexDropdownItem>
                                                    <LumexDropdownItem Key="move">Move to...</LumexDropdownItem>
                                                    <LumexDropdownItem Key="share">Share</LumexDropdownItem>
                                                    <LumexDropdownItem Key="archive">Archive</LumexDropdownItem>
                                                    <LumexDropdownItem Key="delete" Class="text-danger">Delete</LumexDropdownItem>
                                                </LumexDropdownMenu>
                                            </LumexDropdown>
                                        </div>

                                        <!-- Tags -->
                                        @if (task.Tags.Any())
                                        {
                                            <div class="flex flex-wrap gap-1">
                                                @foreach (var tag in task.Tags)
                                                {
                                                    <span class="text-xs px-2 py-0.5 rounded-full @GetTagClass(tag)">@tag</span>
                                                }
                                            </div>
                                        }

                                        <!-- Task Footer -->
                                        <div class="flex items-center justify-between pt-2 border-t border-divider">
                                            <div class="flex items-center gap-2">
                                                <!-- Priority -->
                                                <div class="flex items-center gap-1">
                                                    @GetPriorityIcon(task.Priority)
                                                </div>
                                                <!-- Due Date -->
                                                <span class="text-xs text-default-500 flex items-center gap-1">
                                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                                    </svg>
                                                    @task.DueDate.ToString("MMM d")
                                                </span>
                                            </div>
                                            <!-- Assignees -->
                                            <div class="flex -space-x-2">
                                                @foreach (var assignee in task.Assignees.Take(3))
                                                {
                                                    <LumexAvatar Name="@assignee" Size="Size.Small" Class="ring-2 ring-background w-6 h-6" />
                                                }
                                                @if (task.Assignees.Count > 3)
                                                {
                                                    <div class="w-6 h-6 rounded-full bg-default-300 flex items-center justify-center text-[10px] font-medium ring-2 ring-background">
                                                        +@(task.Assignees.Count - 3)
                                                    </div>
                                                }
                                            </div>
                                        </div>

                                        <!-- Subtasks Progress -->
                                        @if (task.SubtasksTotal > 0)
                                        {
                                            <div class="flex items-center gap-2">
                                                <div class="flex-1 h-1.5 bg-default-200 rounded-full overflow-hidden">
                                                    <div class="h-full bg-success rounded-full" style="width: @(task.SubtasksCompleted * 100 / task.SubtasksTotal)%"></div>
                                                </div>
                                                <span class="text-xs text-default-400">@task.SubtasksCompleted/@task.SubtasksTotal</span>
                                            </div>
                                        }
                                    </LumexCardBody>
                                </LumexCard>
                            </div>
                        }

                        <!-- Add Task Button -->
                        <button class="w-full py-2 rounded-lg border-2 border-dashed border-default-300 text-default-400 hover:border-primary hover:text-primary transition-colors text-sm flex items-center justify-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                            Add Task
                        </button>
                    </div>
                </div>
            }
        </div>
    }
    else if (_currentView == "list")
    {
        <!-- List View -->
        <LumexCard Class="rounded-xl overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-default-100">
                        <tr>
                            <th class="px-2 py-3 text-left text-xs font-semibold text-default-500 uppercase tracking-wider w-10"></th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-default-500 uppercase tracking-wider w-8">
                                <LumexCheckbox @bind-Value="_selectAllTasks" />
                            </th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-default-500 uppercase tracking-wider">Task</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-default-500 uppercase tracking-wider">Status</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-default-500 uppercase tracking-wider">Priority</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-default-500 uppercase tracking-wider">Due Date</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-default-500 uppercase tracking-wider">Assignees</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-default-500 uppercase tracking-wider w-10"></th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-divider">
                        @for (var i = 0; i < _allTasks.Count; i++)
                        {
                            var index = i;
                            var task = _allTasks[index];
                            <tr class="@GetListRowClass(index)"
                                draggable="true"
                                @ondragstart="@(() => OnDragStart(task))"
                                @ondragend="OnDragEnd"
                                @ondragover="@(() => OnListDragOver(index))"
                                @ondragover:preventDefault="true"
                                @ondrop="@(() => OnDropOnListRow(index))"
                                @ondrop:preventDefault="true">
                                <td class="px-2 py-3 cursor-grab active:cursor-grabbing">
                                    <svg class="w-5 h-5 text-default-400" fill="currentColor" viewBox="0 0 24 24">
                                        <circle cx="9" cy="6" r="1.5"></circle>
                                        <circle cx="15" cy="6" r="1.5"></circle>
                                        <circle cx="9" cy="12" r="1.5"></circle>
                                        <circle cx="15" cy="12" r="1.5"></circle>
                                        <circle cx="9" cy="18" r="1.5"></circle>
                                        <circle cx="15" cy="18" r="1.5"></circle>
                                    </svg>
                                </td>
                                <td class="px-4 py-3">
                                    <LumexCheckbox @bind-Value="task.Selected" />
                                </td>
                                <td class="px-4 py-3">
                                    <div class="flex items-center gap-3">
                                        <div>
                                            <p class="font-medium text-default-800">@task.Title</p>
                                            @if (task.Tags.Any())
                                            {
                                                <div class="flex gap-1 mt-1">
                                                    @foreach (var tag in task.Tags.Take(2))
                                                    {
                                                        <span class="text-xs px-2 py-0.5 rounded-full @GetTagClass(tag)">@tag</span>
                                                    }
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </td>
                                <td class="px-4 py-3">
                                    <LumexChip Size="Size.Small" Variant="ChipVariant.Flat" Color="@GetStageColor(task.Stage)">
                                        @GetStageName(task.Stage)
                                    </LumexChip>
                                </td>
                                <td class="px-4 py-3">
                                    <div class="flex items-center gap-1">
                                        @GetPriorityIcon(task.Priority)
                                        <span class="text-sm capitalize text-default-500">@task.Priority</span>
                                    </div>
                                </td>
                                <td class="px-4 py-3">
                                    <span class="text-sm text-default-500">@task.DueDate.ToString("MMM d, yyyy")</span>
                                </td>
                                <td class="px-4 py-3">
                                    <div class="flex -space-x-2">
                                        @foreach (var assignee in task.Assignees.Take(3))
                                        {
                                            <LumexAvatar Name="@assignee" Size="Size.Small" Class="ring-2 ring-background" />
                                        }
                                        @if (task.Assignees.Count > 3)
                                        {
                                            <div class="w-8 h-8 rounded-full bg-default-200 flex items-center justify-center text-xs font-medium ring-2 ring-background">
                                                +@(task.Assignees.Count - 3)
                                            </div>
                                        }
                                    </div>
                                </td>
                                <td class="px-4 py-3">
                                    <LumexDropdown>
                                        <LumexDropdownTrigger>
                                            <LumexButton Variant="Variant.Light" Size="Size.Small" IconOnly="true">
                                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                                    <circle cx="12" cy="6" r="2"></circle>
                                                    <circle cx="12" cy="12" r="2"></circle>
                                                    <circle cx="12" cy="18" r="2"></circle>
                                                </svg>
                                            </LumexButton>
                                        </LumexDropdownTrigger>
                                        <LumexDropdownMenu AriaLabel="Task actions">
                                            <LumexDropdownItem Key="edit">Edit</LumexDropdownItem>
                                            <LumexDropdownItem Key="rename">Rename</LumexDropdownItem>
                                            <LumexDropdownItem Key="duplicate">Duplicate</LumexDropdownItem>
                                            <LumexDropdownItem Key="move">Move to...</LumexDropdownItem>
                                            <LumexDropdownItem Key="share">Share</LumexDropdownItem>
                                            <LumexDropdownItem Key="archive">Archive</LumexDropdownItem>
                                            <LumexDropdownItem Key="delete" Class="text-danger">Delete</LumexDropdownItem>
                                        </LumexDropdownMenu>
                                    </LumexDropdown>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </LumexCard>
    }
    else
    {
        <!-- Calendar View Placeholder -->
        <LumexCard Class="rounded-xl">
            <LumexCardBody Class="p-8 text-center">
                <div class="w-16 h-16 rounded-full bg-default-100 flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-default-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                </div>
                <h3 class="text-lg font-semibold text-default-800 mb-2">Calendar View</h3>
                <p class="text-default-500">Calendar view is coming soon. Switch to Board or List view to manage your tasks.</p>
            </LumexCardBody>
        </LumexCard>
    }

    <!-- Task Statistics -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <LumexCard Class="rounded-xl">
            <LumexCardBody Class="p-4">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-xl bg-blue-100 flex items-center justify-center">
                        <svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                        </svg>
                    </div>
                    <div>
                        <p class="text-2xl font-bold text-default-800">@_allTasks.Count</p>
                        <p class="text-sm text-default-500">Total Tasks</p>
                    </div>
                </div>
            </LumexCardBody>
        </LumexCard>

        <LumexCard Class="rounded-xl">
            <LumexCardBody Class="p-4">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-xl bg-amber-100 flex items-center justify-center">
                        <svg class="w-6 h-6 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div>
                        <p class="text-2xl font-bold text-default-800">@GetTasksForStage("in-progress").Count</p>
                        <p class="text-sm text-default-500">In Progress</p>
                    </div>
                </div>
            </LumexCardBody>
        </LumexCard>

        <LumexCard Class="rounded-xl">
            <LumexCardBody Class="p-4">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-xl bg-success/10 flex items-center justify-center">
                        <svg class="w-6 h-6 text-success" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div>
                        <p class="text-2xl font-bold text-default-800">@GetTasksForStage("done").Count</p>
                        <p class="text-sm text-default-500">Completed</p>
                    </div>
                </div>
            </LumexCardBody>
        </LumexCard>

        <LumexCard Class="rounded-xl">
            <LumexCardBody Class="p-4">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-xl bg-danger/10 flex items-center justify-center">
                        <svg class="w-6 h-6 text-danger" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div>
                        <p class="text-2xl font-bold text-default-800">@_allTasks.Count(t => t.DueDate < DateTime.Now && t.Stage != "done")</p>
                        <p class="text-sm text-default-500">Overdue</p>
                    </div>
                </div>
            </LumexCardBody>
        </LumexCard>
    </div>
</div>

@code {
    private string _currentView = "board";
    private string _searchQuery = string.Empty;
    private bool _selectAllTasks = false;
    private IReadOnlyList<string> _priorityFilter = Array.Empty<string>();
    private IReadOnlyList<string> _assigneeFilter = Array.Empty<string>();
    private TaskItem? _selectedTask = null;
    
    // Drag and drop state
    private TaskItem? _draggedTask = null;
    private string? _dragOverStage = null;
    private int? _dragOverIndex = null;

    private InputFieldSlots _searchClasses = new()
    {
        InputWrapper = "bg-default-100"
    };

    private List<Stage> _stages = new()
    {
        new("backlog", "Backlog", "bg-default-400"),
        new("todo", "To Do", "bg-blue-500"),
        new("in-progress", "In Progress", "bg-amber-500"),
        new("done", "Done", "bg-success")
    };

    private List<TaskItem> _allTasks = new()
    {
        // Backlog
        new("Research competitor analysis", "backlog", "medium", new DateTime(2025, 12, 15), 
            new List<string> { "Alice Chen" }, new List<string> { "Research" }, 0, 0),
        new("Define product roadmap Q1", "backlog", "high", new DateTime(2025, 12, 20),
            new List<string> { "Bob Smith", "Carol White" }, new List<string> { "Planning" }, 0, 0),
        
        // To Do
        new("Design new landing page", "todo", "high", new DateTime(2025, 12, 5),
            new List<string> { "Carol White" }, new List<string> { "Design", "UI/UX" }, 2, 5),
        new("Write API documentation", "todo", "medium", new DateTime(2025, 12, 8),
            new List<string> { "David Lee" }, new List<string> { "Documentation" }, 0, 3),
        new("Set up CI/CD pipeline", "todo", "high", new DateTime(2025, 12, 3),
            new List<string> { "Alice Chen", "David Lee" }, new List<string> { "DevOps" }, 1, 4),
        
        // In Progress
        new("Implement user authentication", "in-progress", "high", new DateTime(2025, 12, 1),
            new List<string> { "David Lee" }, new List<string> { "Backend", "Security" }, 3, 5),
        new("Create dashboard components", "in-progress", "medium", new DateTime(2025, 12, 4),
            new List<string> { "Carol White", "Alice Chen" }, new List<string> { "Frontend", "UI/UX" }, 4, 8),
        new("Database optimization", "in-progress", "low", new DateTime(2025, 12, 10),
            new List<string> { "Bob Smith" }, new List<string> { "Backend", "Performance" }, 2, 6),
        
        // Done
        new("Project setup and configuration", "done", "high", new DateTime(2025, 11, 20),
            new List<string> { "Alice Chen", "Bob Smith" }, new List<string> { "Setup" }, 5, 5),
        new("Design system creation", "done", "medium", new DateTime(2025, 11, 25),
            new List<string> { "Carol White" }, new List<string> { "Design" }, 8, 8),
        new("Initial wireframes", "done", "low", new DateTime(2025, 11, 22),
            new List<string> { "Carol White" }, new List<string> { "Design", "UI/UX" }, 3, 3)
    };

    private List<TaskItem> GetTasksForStage(string stage)
    {
        return _allTasks.Where(t => t.Stage == stage).ToList();
    }

    private void SelectTask(TaskItem task)
    {
        _selectedTask = task;
    }

    private void OpenNewTaskModal()
    {
        // Open modal logic
    }

    private string GetViewButtonClass(string view)
    {
        var baseClass = "flex items-center gap-2 px-3 py-1.5 rounded-md text-sm font-medium transition-colors";
        return _currentView == view
            ? $"{baseClass} bg-background shadow-sm text-default-800"
            : $"{baseClass} text-default-500 hover:text-default-700";
    }

    private RenderFragment GetPriorityIcon(string priority) => priority switch
    {
        "high" => @<svg class="w-4 h-4 text-danger" fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 2L2 12l10 10 10-10L12 2zm0 15l-5-5 5-5 5 5-5 5z"/>
        </svg>,
        "medium" => @<svg class="w-4 h-4 text-warning" fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 2L2 12l10 10 10-10L12 2zm0 15l-5-5 5-5 5 5-5 5z"/>
        </svg>,
        _ => @<svg class="w-4 h-4 text-default-400" fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 2L2 12l10 10 10-10L12 2zm0 15l-5-5 5-5 5 5-5 5z"/>
        </svg>
    };

    private string GetTagClass(string tag) => tag switch
    {
        "Design" => "bg-pink-100 text-pink-600",
        "UI/UX" => "bg-purple-100 text-purple-600",
        "Frontend" => "bg-blue-100 text-blue-600",
        "Backend" => "bg-green-100 text-green-600",
        "DevOps" => "bg-orange-100 text-orange-600",
        "Documentation" => "bg-cyan-100 text-cyan-600",
        "Security" => "bg-red-100 text-red-600",
        "Performance" => "bg-amber-100 text-amber-600",
        "Research" => "bg-indigo-100 text-indigo-600",
        "Planning" => "bg-teal-100 text-teal-600",
        "Setup" => "bg-gray-100 text-gray-600",
        _ => "bg-default-100 text-default-600"
    };

    private ThemeColor GetStageColor(string stage) => stage switch
    {
        "backlog" => ThemeColor.Default,
        "todo" => ThemeColor.Primary,
        "in-progress" => ThemeColor.Warning,
        "done" => ThemeColor.Success,
        _ => ThemeColor.Default
    };

    private string GetStageName(string stage) => _stages.FirstOrDefault(s => s.Key == stage)?.Name ?? stage;

    private record Stage(string Key, string Name, string Color);

    private class TaskItem
    {
        public string Title { get; set; }
        public string Stage { get; set; }
        public string Priority { get; set; }
        public DateTime DueDate { get; set; }
        public List<string> Assignees { get; set; }
        public List<string> Tags { get; set; }
        public int SubtasksCompleted { get; set; }
        public int SubtasksTotal { get; set; }
        public bool Selected { get; set; }

        public TaskItem(string title, string stage, string priority, DateTime dueDate, 
            List<string> assignees, List<string> tags, int subtasksCompleted, int subtasksTotal)
        {
            Title = title;
            Stage = stage;
            Priority = priority;
            DueDate = dueDate;
            Assignees = assignees;
            Tags = tags;
            SubtasksCompleted = subtasksCompleted;
            SubtasksTotal = subtasksTotal;
            Selected = false;
        }
    }
    
    // Drag and drop handlers for Board view
    private void OnDragStart(TaskItem task)
    {
        _draggedTask = task;
    }
    
    private void OnDragEnd()
    {
        _draggedTask = null;
        _dragOverStage = null;
        _dragOverIndex = null;
    }
    
    private void OnDragOver(string stageKey)
    {
        _dragOverStage = stageKey;
    }
    
    private void OnDragLeave()
    {
        _dragOverStage = null;
        _dragOverIndex = null;
    }
    
    private void OnDropOnStage(string stageKey)
    {
        if (_draggedTask != null && _draggedTask.Stage != stageKey)
        {
            _draggedTask.Stage = stageKey;
        }
        _draggedTask = null;
        _dragOverStage = null;
        _dragOverIndex = null;
    }
    
    private string GetDropZoneClass(string stageKey)
    {
        var baseClass = "flex-1 space-y-3 p-3 rounded-xl transition-all duration-200";
        if (_dragOverStage == stageKey && _draggedTask?.Stage != stageKey)
        {
            return $"{baseClass} bg-primary-100 border-2 border-dashed border-primary";
        }
        return $"{baseClass} bg-default-100/50";
    }
    
    private string GetTaskCardClass(TaskItem task)
    {
        var baseClass = "rounded-xl cursor-grab active:cursor-grabbing transition-all duration-200";
        if (_draggedTask == task)
        {
            return $"{baseClass} opacity-50 scale-95";
        }
        return $"{baseClass} hover:shadow-md";
    }
    
    // Drag and drop handlers for List view
    private void OnListDragOver(int index)
    {
        _dragOverIndex = index;
    }
    
    private void OnDropOnListRow(int targetIndex)
    {
        if (_draggedTask != null)
        {
            var draggedIndex = _allTasks.IndexOf(_draggedTask);
            
            if (draggedIndex != -1 && draggedIndex != targetIndex)
            {
                // Remove from current position and insert at target position
                _allTasks.RemoveAt(draggedIndex);
                if (targetIndex > draggedIndex)
                {
                    targetIndex--;
                }
                _allTasks.Insert(targetIndex, _draggedTask);
            }
        }
        _draggedTask = null;
        _dragOverIndex = null;
    }
    
    private string GetListRowClass(int index)
    {
        var baseClass = "transition-all duration-200";
        if (_dragOverIndex == index && _allTasks[index] != _draggedTask)
        {
            return $"{baseClass} bg-primary-50 border-t-2 border-primary";
        }
        if (_draggedTask != null && _allTasks.IndexOf(_draggedTask) == index)
        {
            return $"{baseClass} opacity-50";
        }
        return $"{baseClass} hover:bg-default-50";
    }
}
